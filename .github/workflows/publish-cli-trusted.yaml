name: Publish CLI (Trusted)

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch:
    inputs:
      publish_target:
        description: "Which publish flow to run"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - nightly
      confirm_publish:
        description: 'Required when publish_target=main. Type "publish" to confirm release publish.'
        required: false
        type: string
      force_nightly_publish:
        description: "Force nightly publish"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  publish-main:
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.publish_target == 'main' &&
      github.event.inputs.confirm_publish == 'publish'
    uses: ./.github/workflows/npm-main.yaml
    with:
      confirm_publish: ${{ github.event.inputs.confirm_publish }}

  publish-nightly:
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target == 'nightly')
    uses: ./.github/workflows/npm-nightly.yaml
    with:
      force_publish: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_nightly_publish == 'true' }}
